<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pokeminer Report: {{ pokemon_name }} in {{ area_name }}</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/slider.css') }}">

    <style>
        .map {
            height: 1000px;
        }
        .pokemon-image {
            text-align: center;
            margin: 20px 0;
        }
        .pokemon-image img {
            width: 50%;
        }
    </style>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(drawCharts);

        var backendData = {{ js_data|tojson }};


        function drawCharts () {
            drawHoursChart(backendData.charts_data.hours);
        }

        function drawHoursChart (data) {
            var combinedData = new google.visualization.DataTable();
            combinedData.addColumn('timeofday', 'Hour');
            combinedData.addColumn('number', 'Spawns seen');
            combinedData.addRows(data);
            var chart = new google.visualization.ColumnChart(document.getElementById('hourschart'));
            chart.draw(combinedData, {
                height: 300,
                chartArea: {width: '70%', height: '80%'},
                legend: {position: 'none'},
                viewWindow: {
                    min: [0, 0, 0],
                    max: [23, 59, 0]
                }
            });
        }

        var maps = {heat: null};

        function initMaps() {
            Object.keys(maps).forEach(function (key) {
                maps[key] = new google.maps.Map(document.getElementById(key + 'map'), {
                    zoom: backendData.zoom,
                    center: {lat: backendData.map_center[0], lng: backendData.map_center[1]},
                    disableDefaultUI: true,
                });
            });
        }

        var heatmapLayer;
        function displayHeatmap (points) {
            var layer = new google.maps.visualization.HeatmapLayer({
              data: points
            });
            layer.setMap(maps.heat);
            heatmapLayer = layer;
        }

        var timeHeatmapData;
        function updateHeatmapData (value) {
            var heatmapPoints = [];
            var minuteOfDay = 0;
            for(var i = 0; i < 15; i++){
                minuteOfDay = (1440+value - i) % 1440;
                heatmapPoints.push(timeHeatmapData[minuteOfDay]);
            }

            heatmapPoints = [].concat.apply([], heatmapPoints);
            heatmapLayer.setData(heatmapPoints);

            var hour = Math.floor(value / 60).toLocaleString('en-US', {minimumIntegerDigits:2});
            var minute = (value % 60).toLocaleString('en-US', {minimumIntegerDigits:2});
            
            $('#time_slider_value').val(hour + ':' + minute);
        }

        function loadTimeHeatmapData() {
            $.get('/report/heatmap/time_based?id={{ pokemon_id }}').done(function (result) {
                var rawData = JSON.parse(result);

                timeHeatmapData = rawData.map(function (single_minute) {
                   return single_minute.map(function (elem) {
                       return {
                           location: new google.maps.LatLng(elem.lat, elem.lng),
                           weight: elem.weight,
                       };
                   });
                });
                $('#heatmap_time_slider').show();
            });

        }


        $(function () {
            var heatmapPoints;
            $.get('/report/heatmap?id={{ pokemon_id }}').done(function (result) {
                heatmapPoints = JSON.parse(result).map(function (elem) {
                    return {location: new google.maps.LatLng(elem[0], elem[1]), weight: elem[2]};
                });
            });
            $('#displayHeatmap').on('click', function () {
                displayHeatmap(heatmapPoints);
                $(this).parent().remove();
                loadTimeHeatmapData();
            });
        });
    </script>
</head>
<body>
    <div class="container">
        <h1>Pokeminer Report: #{{ pokemon_id }} {{ pokemon_name }}</h1>
        <h4>Generated on {{ current_date.strftime('%Y-%m-%d %H:%M:%S') }}</h4>

        <p><b>Disclaimer:</b> data may be incomplete due to various issues that might have happened (bugs, unstable servers, bugs on the servers etc.). If there is data about a sighting of a Pokemon in given location at particular time, almost certainly such spawning happened. On the other hand, there is no guarantee that Pokeminer database contains <i>all</i> spawnings, so there might be wild Pokemon not contained in this report. Your mileage may vary.</p>

        <p>This report contains statistics about data gathered during mining session for {{ area_name }} for single species - {{ pokemon_name }}.</p>

        <div class="pokemon-image">
            <img src="/static/larger-icons/{{ pokemon_id }}.png" alt="{{ pokemon_name }}">
        </div>

        <p>During that session, <b> {{ total_spawn_count }}</b> sightings of {{ pokemon_name }} have been seen on an area of about <b>{{ area_size }} square km</b>. Data gathering started on <b>{{ session_start.strftime('%Y-%m-%d %H:%M:%S') }}</b> and ended on <b>{{ session_end.strftime('%Y-%m-%d %H:%M:%S') }}</b>, lasting <b>{{ session_length_hours }} hours</b>.</p>

        <h3>Heatmap</h3>

        <p>All noticed spawn locations of {{ pokemon_name }}. The redder the point is, {{ pokemon_name }} spawned more often there.</p>

        <p><button id="displayHeatmap">Display heatmap</button> (will slow down browser!)</p>

        <div id="heatmap" class="map"></div>

        <div id="heatmap_time_slider" style="display:none;">
            <p for="time_slider">
                Aggregated pokemon activity for {{ pokemon_name }} at: <b><output for="time_slider" id="time_slider_value">always</output></b>
            </p>
            <p><input type="range" min="0" max="1439" value="0" id="time_slider" step="5" oninput="updateHeatmapData(value)"></p>
        </div>

        <h3>Spawning hours</h3>

        <p>At what time of the day has {{ pokemon_name }} been seen most number of times?</p>

        <div id="hourschart"></div>

        <h2>Footnotes</h2>

        <p>This report was generated using pokeminer, a tool for gathering data about Pokemon Go.</p>

        <p>Visit <a href="https://github.com/modrzew/pokeminer">https://github.com/modrzew/pokeminer</a> for more info.</p>

        <p>This report is available under Creative Commons CC-BY-4.0 license: <a href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a>.</p>
    </div>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_key }}&amp;libraries=visualization&amp;callback=initMaps">
    </script>
</body>
</html>
